<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chawezi Miti">

<title>Boundary Line Methodology For Yield Gap Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Boundary Line Methodology For Yield Gap Analysis</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chawezi Miti </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="day-1-introduction-to-boundary-line-analysis" class="level2">
<h2 class="anchored" data-anchor-id="day-1-introduction-to-boundary-line-analysis">DAY 1: INTRODUCTION TO BOUNDARY LINE ANALYSIS</h2>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
<p>This script gives illustration of fitting boundary line models to data and carrying out post-hoc analysis.</p>
</section>
<section id="install-and-load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="install-and-load-libraries">2. Install and Load libraries</h2>
<section id="install-necessary-packages" class="level3">
<h3 class="anchored" data-anchor-id="install-necessary-packages">2.1 Install necessary packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"devtools"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(devtools)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("BLA")</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">install_github</span>(<span class="st">"chawezimiti/BLA"</span>) <span class="co"># install the development version of BLA from Github</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"aplpack"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-libraries-into-your-r-session" class="level3">
<h3 class="anchored" data-anchor-id="load-libraries-into-your-r-session">2.2 Load libraries into your <code>R</code> session</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BLA) </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aplpack)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="boundary-line-analysis-task" class="level2">
<h2 class="anchored" data-anchor-id="boundary-line-analysis-task">3. Boundary line analysis task</h2>
<p>The <code>BLA</code> package contains an inbuilt dataset called <code>soil</code> that contains data on wheat yield, soil P and soil pH gathered from farms across the UK. The task for this practical is to:</p>
<ol type="1">
<li><p>Fit the boundary line model describing wheat yield as a function of soil Phosphorus and soil pH.</p></li>
<li><p>Determine the most-limiting factor at each observation point.</p></li>
</ol>
<p>NB: A second dataset called <code>maize</code> is also provided via a github that contains Maize yields, soil pH, soil K and soil N gathered from Ethiopia. This will be used for follow up practice exercises.</p>
</section>
<section id="test-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="test-assumptions">4. Test Assumptions</h2>
<section id="normality-check" class="level3">
<h3 class="anchored" data-anchor-id="normality-check">4.1. Normality check</h3>
<p>In boundary line fitting, the independent and dependent variables should plausibly be drawn from an underlying bivariate normal distribution albeit with some censoring of the response variable. Here we check this assumption using the <code>summastat()</code> function. Lets start with the boundary line for yield as a function of soil P.</p>
<section id="soil-p" class="level4">
<h4 class="anchored" data-anchor-id="soil-p">4.1.1. Soil P</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(soil<span class="sc">$</span>P) <span class="co"># From results, P can not be assumed to be from a normal distribution and so we try a log transformation.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(<span class="fu">log</span>(soil<span class="sc">$</span>P))<span class="co"># The log-transformed P can be assumed to be from a normal distribution</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wheat-yield" class="level4">
<h4 class="anchored" data-anchor-id="wheat-yield">4.1.2 Wheat yield</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(soil<span class="sc">$</span>yield)<span class="co"># Wheat yield can be assumed to be from a normal distribution</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="outlier-detection" class="level3">
<h3 class="anchored" data-anchor-id="outlier-detection">4.2. Outlier detection</h3>
<p>The boundary line model is highly sensitive to outliers and for this reason, bivariate outliers are identified and removed from the data. This is achieved using the bagplot. The <code>bag</code> plot is a bivariate equivalent of the univariate boxplot. It is composed of a <code>depth median</code>, <code>bag</code> and <code>loop</code>. The <code>depth median</code> describes the center of the data cloud and is equivalent to the median value in the univariate boxplot, the <code>bag</code> contains 50% of the data and the <code>loop</code> contains data outside the bag which are not outliers. Here we identify and remove outliers from the dataset using the <code>bagplot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x=</span><span class="fu">log</span>(soil<span class="sc">$</span>P), <span class="at">y=</span>soil<span class="sc">$</span>yield) <span class="co">#Input for the bagplot() is a dataframe of x and y.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">which</span>(<span class="fu">is.na</span>(dat<span class="sc">$</span>x)<span class="sc">==</span>T),<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>x,<span class="at">na.rm=</span>T)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">which</span>(<span class="fu">is.na</span>(dat<span class="sc">$</span>y)<span class="sc">==</span>T),<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat<span class="sc">$</span>y,<span class="at">na.rm=</span>T)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">bagplot</span>(dat,<span class="at">show.whiskers =</span> F)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Bag"</span>,<span class="st">"Loop"</span>,<span class="st">"Depth median"</span>, <span class="st">"outlier"</span>), <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">15</span>,<span class="dv">8</span>,<span class="dv">3</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="fu">adjustcolor</span>( <span class="st">"#7799ff"</span>, <span class="at">alpha.f =</span> <span class="fl">0.7</span>), <span class="st">"#aaccff"</span>,<span class="st">"red"</span>,<span class="st">"red"</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating a new data set without bivariate outliers i.e points in the bag and loop only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rbind</span>(out<span class="sc">$</span>pxy.bag,out<span class="sc">$</span>pxy.outer)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testing-evidence-for-presence-of-boundary-in-dataset" class="level3">
<h3 class="anchored" data-anchor-id="testing-evidence-for-presence-of-boundary-in-dataset">4.3. Testing evidence for presence of boundary in dataset</h3>
<p>Fitting boundary line models to data works on the assumption that data has boundary limiting structure at the upper edges. This assumption is assessed using <code>expl_boundary()</code> function. The inputs are the <code>x</code> and <code>y</code> variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> vals[,<span class="dv">1</span>] </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> vals[,<span class="dv">2</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">expl_boundary</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">shells=</span><span class="dv">10</span>,<span class="at">simulations=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="boundary-model-fitting-methods" class="level2">
<h2 class="anchored" data-anchor-id="boundary-model-fitting-methods">5. Boundary Model Fitting Methods</h2>
<section id="bolides-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="bolides-algorithm">5.1 Bolides algorithm</h3>
<p>This method fits the boundary line using the algorithm proposed by Schnug <em>et al</em>. (1995). The <code>bolides()</code> function implements this approach. You can view the required arguments by accessing the function’s help page.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>?bolides</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting the model to <code>model="explore"</code> allows us to view the selected boundary points. This enables the selection of an appropriate boundary model and sensible initial starting values for the model.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">model =</span> <span class="st">"explore"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># From the plot, it can be seen that a `"trapezium"` model will be more appropriate for this data set. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function <code>startValues()</code> can be used to determine initial start values for the proposed model. You can view the required arguments by accessing the function’s help page.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Note</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li><p>All boundary fitting methods require initial starting values for the parameters of a proposed model. The initial starting values are optimized to find the parameters of the proposed model as in the <code>optim()</code> function in base <code>R</code>.</p></li>
<li><p>Note that some computers, for the <code>startValues()</code> function to work effectively, the appearance zoom in the global options of <code>R</code> and your computer display zoom should be equal i.e.both should be at 100%.</p></li>
</ol>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>?<span class="fu">startValues</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With a scatter plot active in the plot window, run the function and then use the mouse to click on the plot the boundary points that follow the proposed model structure.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fill the suggested initial starting values in a vector.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">14</span>,<span class="dv">104</span>,<span class="sc">-</span><span class="dv">22</span>) <span class="co"># start values is a vector of five consists of intercept, slope, plateau yield, intercept2 and slope2. </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, <span class="at">start =</span> start,<span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>model1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model can be used to determine maximum yields for any given value of soil P using the function <code>predictBL()</code>.</p>
<ol type="1">
<li>What are the maximum possible yields at soil P values of 4.5, 7.4, 12.2, 20.1 and 54.5 mg/kg?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="fl">7.4</span>, <span class="fl">12.2</span>, <span class="fl">20.1</span>, <span class="fl">54.5</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>P_log <span class="ot">&lt;-</span> <span class="fu">log</span>(P)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>Max_yield <span class="ot">&lt;-</span> <span class="fu">predictBL</span>(model1, P_log) <span class="co"># the argument inputs are the boundary line model and the independent values (in this case P_log)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>Max_yield</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 1</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<p>A link to dataset <code>maize</code> that contains maize yields and various soil properties is provided below. You can read it into your <code>R</code> session using the following code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>maize <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://raw.githubusercontent.com/chawezimiti/BLA_NETHERLAND_Rothamsted/refs/heads/main/maize_data.csv"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(maize)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Fit the boundary line model for Maize yield as a function of soil N using the <code>bolides()</code> function assigning it mod_1</li>
</ol>
</div>
</div>
</section>
<section id="binning-method" class="level3">
<h3 class="anchored" data-anchor-id="binning-method">5.2 Binning method</h3>
<p>The binning method involves splitting the data into several sections along the x-axis and selecting a boundary point in each section based on a set criteria (e.g.&nbsp;95<span class="math inline">\(^{\rm th}\)</span> and 99<span class="math inline">\(^{\rm th}\)</span> percentile). The <code>blbin()</code> function implements this approach. You can view the required arguments by accessing the function’s help page.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>?blbin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(x), <span class="fu">max</span>(x), (<span class="fu">max</span>(x)<span class="sc">-</span><span class="fu">min</span>(x))<span class="sc">/</span><span class="dv">10</span>) <span class="co"># to get 10 bins</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">blbin</span>(<span class="at">x=</span>x, <span class="at">y=</span>y, <span class="at">bins=</span>bins, <span class="at">model =</span> <span class="st">"explore"</span>, <span class="at">tau=</span><span class="fl">0.99</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>"trapezium"</code> model will be more appropriate and the values for <code>start</code> can be determined.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">4.75</span>, <span class="fl">3.23</span>, <span class="fl">13.3</span>, <span class="fl">24.87</span>,<span class="sc">-</span><span class="fl">2.95</span> )</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">blbin</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, bins, <span class="at">start =</span> start, <span class="at">model =</span> <span class="st">"trapezium"</span>, </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">tau=</span><span class="fl">0.99</span>, </span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"t ha"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>model2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 2</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<p>A link to dataset <code>maize</code> that contains Maize yields and various soil properties is provided below. You can read it into your <code>R</code> session using the following code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>maize <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://raw.githubusercontent.com/chawezimiti/BLA_NETHERLAND_Rothamsted/refs/heads/main/maize_data.csv"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(maize)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Fit the boundary line model for Maize yield as a function of soil N using the <code>blbin()</code> function assigning it mod_2.</li>
</ol>
</div>
</div>
</section>
<section id="quantile-regression-method" class="level3">
<h3 class="anchored" data-anchor-id="quantile-regression-method">5.3 Quantile regression method</h3>
<p>This method fits the boundary line model based the principle of quantile regression. The <code>blqr()</code> function implements this approach. You can view the required arguments by accessing the function’s help page.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>?blqr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>blqr()</code> function does not have the <code>"explore"</code> option. A plot of the <code>x</code> and <code>y</code> variables can be viewed to identify the appropriate boundary model and its initial <code>start</code> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x,y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>"trapezium"</code> model will be used for this data.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="fl">13.5</span>,<span class="dv">31</span>,<span class="sc">-</span><span class="fl">4.5</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">blqr</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, <span class="at">start =</span> start, <span class="at">model =</span> <span class="st">"trapezium"</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">tau=</span><span class="fl">0.99</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ mg L"</span><span class="sc">^-</span><span class="dv">1</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>) <span class="co"># may take a few seconds to ran</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>model3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The resulting model can be used to determine boundary line response for any given value of soil P using the <code>predictBL()</code> function.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 3</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li><p>Use the <code>maize</code> dataset to fit the boundary line model for maize yield as function of soil N using the <code>blqr()</code> function assigning it mod_3.</p></li>
<li><p>Predict the maximum possible maize yields for any 4 points in the dataset.</p></li>
</ol>
</div>
</div>
</section>
<section id="censored-bivariate-normal-model" class="level3">
<h3 class="anchored" data-anchor-id="censored-bivariate-normal-model">5.4 Censored bivariate normal model</h3>
<p>This method fits the boundary line model based the principle of Milne et al.&nbsp;(2006). The <code>cbvn()</code> function implements this approach. You can view the required arguments by accessing the function’s help page.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>?cbvn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As with the <code>blqr()</code> function, <code>cbvn()</code> does not have the <code>"explore"</code> option. Therefore, a plot of the <code>x</code> and <code>y</code> variables can be viewed to identify the appropriate boundary model and its initial start values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x,y,<span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">xlab=</span><span class="st">"soil P"</span>, <span class="at">ylab =</span> <span class="st">"Yield (t/ha)"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>"trapezium"</code> model will be used for this data.</p>
<section id="determination-of-initial-starting-values" class="level4">
<h4 class="anchored" data-anchor-id="determination-of-initial-starting-values">5.4.1 Determination of initial starting values</h4>
<p>The <code>start</code> values for a <code>"trapezium"</code> model in the <code>cbvn()</code> function is a vector of length 10 comprising the y-intercept, slope, plateau value, second y-intercept, second slope and data distribution properties i.e means of <code>x</code> and <code>y</code>, standard deviation of <code>x</code> and <code>y</code>, and their correlation respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can follow 2 options.</p>
<ol type="1">
<li>Using single set of starting values</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>start1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">4.3</span>,<span class="fl">3.4</span>,<span class="fl">13.8</span>,<span class="fl">32.8</span>,<span class="sc">-</span><span class="fl">4.9</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Using multiple sets of starting values</li>
</ol>
<p>We determine multiple start values to avoid model sticking to a local optima solution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>start2 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">4.3</span>,<span class="fl">3.4</span>,<span class="fl">13.8</span>,<span class="fl">32.8</span>,<span class="sc">-</span><span class="fl">4.9</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">2.5</span>,<span class="fl">4.1</span>,<span class="fl">13.42</span>,<span class="dv">32</span>,<span class="sc">-</span><span class="fl">4.8</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">3.5</span>,<span class="fl">3.7</span>,<span class="fl">13.35</span>,<span class="fl">47.7</span>,<span class="sc">-</span><span class="fl">8.4</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">2.83</span>,<span class="fl">4.11</span>,<span class="fl">13.7</span>,<span class="fl">32.</span>,<span class="sc">-</span><span class="fl">4.6</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">4.1</span>,<span class="fl">3.4</span>,<span class="fl">13.6</span>,<span class="dv">29</span>,<span class="sc">-</span><span class="fl">4.1</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="determination-of-standard-deviation-of-measurement-error" class="level4">
<h4 class="anchored" data-anchor-id="determination-of-standard-deviation-of-measurement-error">5.4.2 Determination of standard deviation of measurement error</h4>
<p>The standard deviation of measurement error (<code>sigh</code>) is a fixed parameter for <code>cbvn()</code>. As we do not have a direct measure of <code>sigh</code>, it is determined by log-likelihood profiling. In log-likelihood profiling, the log-likelihoods of several suggested values of <code>sigh</code> are determined given the data distribution and the suggested model. The <code>sigh</code> value with the largest log-likelihood is selected. This is achieved using the <code>ble_profile()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>sigh <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.3</span>,<span class="fl">0.4</span>,<span class="fl">0.5</span>,<span class="fl">0.6</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>,<span class="fl">0.9</span>,<span class="dv">1</span>) <span class="co"># we suggest sigh values ranging from 0.3 to 1 t/ha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li>Using single set of starting values</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ble_profile</span>(<span class="at">data =</span> vals, <span class="at">start =</span> start1, <span class="at">sigh =</span> sigh, <span class="at">model =</span> <span class="st">"trapezium"</span>, <span class="at">plot =</span> T)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: This function will take a longer to run as it is evaluating each sigh value.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Using multiple sets of starting values</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>profile <span class="ot">&lt;-</span> <span class="fu">lapply</span>(start2, <span class="cf">function</span>(start2) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(sigh, <span class="cf">function</span>(sigh) {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ble_profile</span>(<span class="at">data =</span> vals, <span class="at">start =</span> start2, <span class="at">sigh =</span> sigh, <span class="at">model =</span> <span class="st">"trapezium"</span>, <span class="at">plot =</span> F)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract log-likelihood and sigh (Merror) values from profile list</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>log_likelihood <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(profile, <span class="cf">function</span>(sublist) {</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(sublist, <span class="cf">function</span>(x) x[[<span class="st">"log-likelihood"</span>]])</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>Merror<span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(profile, <span class="cf">function</span>(sublist) {</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(sublist, <span class="cf">function</span>(x) x[[<span class="st">"Merror"</span>]])</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The sigh with the maximum log-likelihood value</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>Merror[<span class="fu">which</span>(log_likelihood<span class="sc">==</span><span class="fu">max</span>(log_likelihood, <span class="at">na.rm =</span> T))]<span class="co"># profile maximized  at 0.4 t/ha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting the log-likelihood profile for visualization</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>me_profile<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">x=</span>Merror,<span class="at">y=</span>log_likelihood)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>me_profile<span class="ot">&lt;-</span>me_profile[<span class="fu">order</span>(Merror),] <span class="co"># ordering data from smallest to largest Merror</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>vec<span class="ot">&lt;-</span><span class="fu">vector</span>()</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(me_profile<span class="sc">$</span>x)){ </span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>  maxy<span class="ot">&lt;-</span><span class="fu">max</span>(me_profile[<span class="fu">which</span>(me_profile<span class="sc">$</span>x<span class="sc">==</span>i),]<span class="sc">$</span>y, <span class="at">na.rm =</span> T)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  vec<span class="ot">&lt;-</span><span class="fu">c</span>(vec,maxy)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ploting the largest value at each Merror</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">unique</span>(me_profile<span class="sc">$</span>x),vec,<span class="at">pch=</span><span class="dv">16</span>, </span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">bold</span>(sigma[e]<span class="sc">*</span><span class="st">"/t ha"</span><span class="sc">^-</span><span class="dv">1</span>)),</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="fu">expression</span>(<span class="fu">bold</span>(log<span class="sc">-</span>Likelihood)),</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.8</span>, <span class="at">cex.axis=</span><span class="fl">1.8</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">unique</span>(me_profile<span class="sc">$</span>x),vec, <span class="at">lty=</span><span class="dv">5</span>, <span class="at">lwd=</span><span class="fl">1.5</span>) </span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>Merror[<span class="fu">which</span>(log_likelihood<span class="sc">==</span><span class="fu">max</span>(log_likelihood, <span class="at">na.rm =</span> T))],</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="dv">5</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="fl">1.3</span>) <span class="co"># sigh with largest log-likelihood</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-the-boundary-line-using-cbvn-model" class="level4">
<h4 class="anchored" data-anchor-id="fitting-the-boundary-line-using-cbvn-model">5.4.3 Fitting the boundary line using cbvn model</h4>
<ol type="1">
<li><strong>Using single set of starting values</strong></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> <span class="fu">cbvn</span>(<span class="at">data=</span>vals, <span class="at">start =</span> start1, <span class="at">sigh=</span><span class="fl">0.4</span>, <span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">optim.method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ mg L"</span><span class="sc">^-</span><span class="dv">1</span>),</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li><strong>Using multiple sets of starting values</strong></li>
</ol>
<p>The <code>lapply()</code> function is used here to allows us to loop the <code>cbvn()</code> over the different start values. The <code>tryCatch()</code> allows the loop function to continue to the next input when the function fails to converge at a given input combination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">lapply</span>(start2, <span class="cf">function</span>(start2) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbvn</span>(<span class="at">data=</span>vals, <span class="at">start =</span> start2, <span class="at">sigh=</span><span class="fl">0.4</span>, <span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">optim.method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ mg L"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>),</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NA</span>) </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The solution with the smallest AIC, an output of the <code>cbvn()</code> function, is selected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model4 <span class="ot">&lt;-</span> models[[<span class="fu">which.min</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="at">X=</span>models,<span class="at">FUN =</span> <span class="cf">function</span>(a){</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  b<span class="ot">&lt;-</span><span class="fu">tryCatch</span>(a<span class="sc">$</span>AIC[<span class="dv">2</span>,<span class="dv">1</span>],<span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NA</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(b)})))]]</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>model4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 4</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li><p>Use the <code>maize</code> dataset to fit the boundary line model for maize yield as function of soil N using the <code>cbvn()</code> function assigning it mod_4.</p></li>
<li><p>Predict the maximum possible maize yields for any 4 points in the dataset.</p></li>
</ol>
</div>
</div>
</section>
</section>
<section id="run-the-code-for-soil-ph-below" class="level3">
<h3 class="anchored" data-anchor-id="run-the-code-for-soil-ph-below">5.4.4 Run the code for soil pH below</h3>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Boundary line model for soil pH from the <code>Soil</code> dataset</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Determine the boundary line for soil pH from the <code>Soil</code> dataset (within the <code>BLA</code>) and assign it model5. Use the <code>sigh = 0.4</code>. There is no need to test for presence of boundary as it has already been established earlier using Soil P.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Test for Normality-------------------------------------------------------------------</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(soil<span class="sc">$</span>pH) </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(<span class="fu">log</span>(soil<span class="sc">$</span>pH)) <span class="co"># transformation doesn't improve results</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Identify and remove outliers --------------------------------------------------------</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x=</span>soil<span class="sc">$</span>pH, <span class="at">y=</span>soil<span class="sc">$</span>yield) <span class="co"># Input for the bagplot() </span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>dat2[<span class="fu">which</span>(<span class="fu">is.na</span>(dat2<span class="sc">$</span>x) <span class="sc">==</span> T),<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat2<span class="sc">$</span>x, <span class="at">na.rm=</span>T) <span class="co">#replace missing values with mean </span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>dat2[<span class="fu">which</span>(<span class="fu">is.na</span>(dat2<span class="sc">$</span>y) <span class="sc">==</span> T),<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">mean</span>(dat2<span class="sc">$</span>y, <span class="at">na.rm=</span>T)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">bagplot</span>(dat2,<span class="at">show.whiskers =</span> F)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>vals2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(out2<span class="sc">$</span>pxy.bag, out2<span class="sc">$</span>pxy.outer) </span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Select boundary model and initial starting values------------------------------------</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vals2, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">xlab=</span><span class="st">"soil P"</span>, <span class="at">ylab =</span> <span class="st">"Yield (t/ha)"</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"lp"</span>)</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> vals2[,<span class="dv">1</span>]</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> vals2[,<span class="dv">2</span>]</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>start2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">6.07</span>,<span class="fl">3.05</span>,<span class="fl">13.53</span>,<span class="fu">mean</span>(X),<span class="fu">mean</span>(Y),<span class="fu">sd</span>(X),<span class="fu">sd</span>(Y),<span class="fu">cor</span>(X,Y))</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Fit the boundary model-------------------------------------------------------------</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>model5 <span class="ot">&lt;-</span> <span class="fu">cbvn</span>(<span class="at">data=</span>vals2, <span class="at">start =</span> start2, <span class="at">sigh=</span><span class="fl">0.4</span>, <span class="at">model =</span> <span class="st">"lp"</span>,</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>               <span class="at">optim.method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>               <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Soil pH"</span>),</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>               <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>model5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="post-hoc-analysis" class="level2">
<h2 class="anchored" data-anchor-id="post-hoc-analysis">6. Post-hoc analysis</h2>
<section id="predicting-boundary-yield-for-each-data-point-in-our-dataset" class="level3">
<h3 class="anchored" data-anchor-id="predicting-boundary-yield-for-each-data-point-in-our-dataset">6.1 Predicting boundary yield for each data point in our dataset</h3>
<p>The largest expected yield for each value of soil P in our data set is estimated from the boundary line model parameters using the function <code>predictBL()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>P_data <span class="ot">&lt;-</span><span class="fu">log</span>(soil<span class="sc">$</span>P) <span class="co"># extracting soil P from the data set</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>P_data[<span class="fu">which</span>(<span class="fu">is.na</span>(P_data)<span class="sc">==</span>T)]<span class="ot">&lt;-</span><span class="fu">mean</span>(P_data,<span class="at">na.rm=</span>T) <span class="co"># replace missing values with mean soil P value</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>P<span class="ot">&lt;-</span><span class="fu">predictBL</span>(model4,P_data) <span class="co"># boundary yield for soil P</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 5</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Use the results from your model5 for soil pH to predict the largest yields for each value of soil pH in the <code>soil</code> dataset. Replace the missing pH values with the mean and assign the predicted yields as pH.</li>
</ol>
</div>
</div>
</section>
<section id="determining-the-most-limiting-factor" class="level3">
<h3 class="anchored" data-anchor-id="determining-the-most-limiting-factor">6.2 Determining the most-limiting factor</h3>
<p>One of the key advantages of boundary line analysis is its ability to identify the most limiting factor among multiple variables by comparing their boundary lines. From the predicted boundary yield using model4 and model5 for soil P and soil pH respectively, we can determine which factor, soil P or soil pH, is most-limiting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>output <span class="ot">&lt;-</span> <span class="fu">limfactor</span>(P, pH) </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This produces a list of length 2, containing a vector of most-limiting factor for each point in dataset and the maximum predicted response in the dataset.</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># a) Attainable yield</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>Attainable_yield <span class="ot">&lt;-</span> output[[<span class="dv">2</span>]]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># b) Identified most limiting factor</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>Limiting_factors <span class="ot">&lt;-</span> output[[<span class="dv">1</span>]]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(Limiting_factors)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Graphical plot</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>{<span class="fu">barplot</span>(<span class="fu">prop.table</span>(<span class="fu">table</span>(Limiting_factors[,<span class="dv">2</span>]))<span class="sc">*</span><span class="dv">100</span>,</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab =</span> <span class="st">"Percentage (%)"</span>,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">xlab =</span> <span class="st">"Soil property"</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"grey"</span>,</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">90</span>))</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">1</span>, <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">4</span>, <span class="at">by =</span> <span class="dv">1</span>), <span class="at">labels =</span> <span class="cn">FALSE</span>, <span class="at">lwd =</span> <span class="dv">1</span>, <span class="at">col.ticks =</span> <span class="st">"white"</span>)  </span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="at">side =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="explained-and-unexplained-yield-gap" class="level3">
<h3 class="anchored" data-anchor-id="explained-and-unexplained-yield-gap">6.3 Explained and Unexplained Yield gap</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>soil<span class="sc">$</span>yield[<span class="fu">which</span>(soil<span class="sc">$</span>yield <span class="sc">&gt;</span> Attainable_yield)] <span class="ot">&lt;-</span> Attainable_yield</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(Limiting_factors<span class="sc">$</span>Rs, soil<span class="sc">$</span>yield,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Predicted yield (t/ha)"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Actual yield (/ha)"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span>Attainable_yield, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lty=</span><span class="dv">5</span>, <span class="at">lwd=</span><span class="dv">1</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">c</span>(<span class="fu">min</span>(Limiting_factors<span class="sc">$</span>Rs),<span class="fu">max</span>(Limiting_factors<span class="sc">$</span>Rs)), </span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">min</span>(Limiting_factors<span class="sc">$</span>Rs),<span class="fu">max</span>(Limiting_factors<span class="sc">$</span>Rs)), </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>,<span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Att yield"</span>, <span class="st">"1:1 line"</span>),</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">1</span>), <span class="at">col=</span><span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="at">cex =</span> <span class="fl">0.8</span>)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co">#---Exp and  Unexp</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="dv">9</span>,<span class="dv">5</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"red"</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">arrows</span>(<span class="at">x0=</span><span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">9</span>),<span class="at">y0=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">9</span>),<span class="at">x1=</span><span class="fu">c</span>(<span class="dv">9</span>,<span class="dv">9</span>),<span class="at">y1=</span><span class="fu">c</span>(<span class="dv">9</span>,Attainable_yield), <span class="at">code =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="fl">1.4</span>, <span class="at">lty =</span> <span class="dv">5</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(<span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">8</span>),<span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">11</span>), <span class="fu">c</span>(<span class="st">"Unexplained Yg"</span>, <span class="st">"Explained Yg"</span>), <span class="at">cex=</span><span class="fl">0.8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="additional-material-using-your-own-defined-model" class="level2">
<h2 class="anchored" data-anchor-id="additional-material-using-your-own-defined-model">7. Additional Material: Using your own defined model</h2>
<p>The illustrated methods for fitting the boundary line have used the in-built models. These include the <code>"blm"</code>, <code>"lp"</code>, <code>"trapezium"</code>, <code>"mit"</code>, <code>"schmidt"</code>, <code>"logistic"</code>, <code>"inv-logistic"</code>, <code>"double-logistic"</code> and <code>"qd"</code> models. However, there are some cases where one wants to fit another model which is not part of the in-built models. The following steps will illustrate how to fit a custom model. Though this will be illustrated using the <code>bolides()</code> function, it also applies for the <code>blbin()</code>, <code>blqr()</code> and <code>cbvn()</code> functions.</p>
<p>Assuming that the initial data exploratory step have been done, the first step is to check the structure of the boundary points using the argument <code>model="explore"</code> in the <code>bolides()</code> function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>x,<span class="at">model=</span><span class="st">"explore"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets say you want to fit a model</p>
<p><span class="math display">\[
y=\beta_0 - \beta_1(x-\beta_2)^2
\]</span></p>
<p>The model is written in form of an <code>R</code> function and the parameters should always be written in alphabetical order as <em><strong>a</strong>, <strong>b</strong></em> and <strong><em>c</em></strong> for a three parameter function, <em><strong>a</strong>, <strong>b</strong>,<strong>c</strong></em> and <strong><em>d</em></strong> for four parameter function and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>custom_function<span class="ot">&lt;-</span><span class="cf">function</span>(x,a,b,c){</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span> a <span class="sc">-</span> b<span class="sc">*</span>(x<span class="sc">-</span>c)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step is to suggest the initial start <code>start</code> values. These should be sensible values else the function will not converge. These should be arranges in alphabetical order as <code>start=c(a,b,c)</code>. Replace a, b and c with numeric values of your choice.</p>
<p>The arguments of <code>bolides()</code> function can now be added. In this case, the argument <code>model</code> while be set to <code>"other"</code>. The arguments <code>equation</code> should now be set to your custom function (<code>equation=custom_function</code>)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>start<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">13.5</span>,<span class="dv">3</span>,<span class="fl">3.3</span>)  </span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>model5<span class="ot">&lt;-</span><span class="fu">bolides</span>(vals[,<span class="dv">1</span>], vals[,<span class="dv">2</span>], <span class="at">start =</span> start, <span class="at">model =</span> <span class="st">"other"</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">equation=</span>custom_function,</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/mg L"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">pch=</span><span class="dv">16</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">3.8</span>,<span class="fl">14.5</span>), <span class="at">col=</span><span class="st">"grey"</span>,<span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>model5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The parameters of the models are shown in the results. A prediction of the boundary response values for each value of <em><code>x</code></em> can the be done as previously shown using the <code>predictBL()</code> function.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 6</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>From the <code>maize</code> fit the boundary line model for soil N using a custom model of your choice.</li>
</ol>
</div>
</div>
</section>
<section id="day-2-boundary-line-exercise-session" class="level2">
<h2 class="anchored" data-anchor-id="day-2-boundary-line-exercise-session">DAY 2: BOUNDARY LINE EXERCISE SESSION</h2>
</section>
<section id="yield-gap-analysis-using-the-maize-dataset" class="level2">
<h2 class="anchored" data-anchor-id="yield-gap-analysis-using-the-maize-dataset">1. Yield gap analysis using the maize dataset</h2>
<p>The link below provides access to a dataset called <code>maize</code>, which contains maize yields along with various soil properties gathered from farms in Ethiopia:</p>
<p>https://raw.githubusercontent.com/chawezimiti/BLA_NETHERLAND_Rothamsted/refs/heads/main/maize_data.csv</p>
<ol type="1">
<li><p>Identify the most-limiting factor at each point in the data set and produce a plot showing the proportions of each limiting factor.</p></li>
<li><p>Identify the critical values for each factor in the dataset.</p></li>
</ol>
</section>
<section id="yield-gap-analysis-using-own-data" class="level2">
<h2 class="anchored" data-anchor-id="yield-gap-analysis-using-own-data">2. Yield gap analysis using own data</h2>
<p>If you have any other data which you would like to conduct yield gap analysis.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>