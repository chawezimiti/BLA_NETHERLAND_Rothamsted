<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>BOUNDARY LINE ANALYSIS FOR YIELD GAP ANALYSIS</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="quarto_files/libs/clipboard/clipboard.min.js"></script>
<script src="quarto_files/libs/quarto-html/quarto.js"></script>
<script src="quarto_files/libs/quarto-html/popper.min.js"></script>
<script src="quarto_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="quarto_files/libs/quarto-html/anchor.min.js"></script>
<link href="quarto_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="quarto_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="quarto_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="quarto_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="quarto_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BOUNDARY LINE ANALYSIS FOR YIELD GAP ANALYSIS</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
</section>
<section id="load-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-libraries">2. Load libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(BLA) </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(aplpack)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">3. Load data</h2>
</section>
<section id="test-assumptions" class="level2">
<h2 class="anchored" data-anchor-id="test-assumptions">4. Test Assumptions</h2>
<section id="normality-check-for-the-soil-p" class="level3">
<h3 class="anchored" data-anchor-id="normality-check-for-the-soil-p">4.1. Normality check for the soil P</h3>
<p>When the censored bivariate normal model is used, the variables x and y should plausibly be drawn from an underlying bivariate normal distribution albeit with some censoring of the y variable. Here we check this assumption using the summastat() function.</p>
<section id="soil-p" class="level4">
<h4 class="anchored" data-anchor-id="soil-p">4.1.1. Soil P</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(soil<span class="sc">$</span>P) <span class="co"># From results, P can not be assumed to be from a normal distribution and \# so we try a log transformation.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(<span class="fu">log</span>(soil<span class="sc">$</span>P))<span class="co"># The log-transformed P can be assumed to be from a normal distribution</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="wheat-yield" class="level4">
<h4 class="anchored" data-anchor-id="wheat-yield">4.1.2 Wheat yield</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summastat</span>(soil<span class="sc">$</span>yield)<span class="co"># Wheat yield can be assumed to be from a normal distribution</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="outlier-detection-using-bagplot-function" class="level3">
<h3 class="anchored" data-anchor-id="outlier-detection-using-bagplot-function">4.2. Outlier detection using bagplot() function</h3>
<p>The boundary line model is highly sensitive to outliers and for this reason, bivariate outliers are identified and removed from the data. This is achieved using the bagplot method. The <code>bag</code> plot is a bivariate equivalent of the univariate boxplot. It is composed of a <code>depth median</code>, <code>bag</code> and <code>loop</code>. The <code>depth median</code> describes the center of the data cloud and is equivalent to the median value in the univariate boxplot, the <code>bag</code> contains 50% of the data and the <code>loop</code> contains data outside the bag which are not outliers. Here we identify and remove outliers from the dataset using the <code>bagplot()</code> function from the <code>aplpack</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x=</span><span class="fu">log</span>(soil<span class="sc">$</span>P), <span class="at">y=</span>soil<span class="sc">$</span>yield) <span class="co">#Input for the bagplot() is a dataframe of x and y.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">bagplot</span>(dat,<span class="at">show.whiskers =</span> F)<span class="co"># Figure 2 in article</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Bag"</span>,<span class="st">"Loop"</span>,<span class="st">"Depth median"</span>, <span class="st">"outlier"</span>), <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">15</span>,<span class="dv">8</span>,<span class="dv">3</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="fu">adjustcolor</span>( <span class="st">"#7799ff"</span>, <span class="at">alpha.f =</span> <span class="fl">0.7</span>), <span class="st">"#aaccff"</span>,<span class="st">"red"</span>,<span class="st">"red"</span>)) <span class="co">#adds legend </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating a new data set without bivariate outliers i.e points in the bag and loop only.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>vals <span class="ot">&lt;-</span> <span class="fu">rbind</span>(out<span class="sc">$</span>pxy.bag,out<span class="sc">$</span>pxy.outer)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vals)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="testing-evidence-for-presence-of-boundary-in-dataset" class="level3">
<h3 class="anchored" data-anchor-id="testing-evidence-for-presence-of-boundary-in-dataset">4.3. Testing evidence for presence of boundary in dataset</h3>
<p>Fitting boundary line models to data works on the assumption that data has boundary structure at the upper edges of the data. This assumption can be assessed using <code>expl_boundary()</code> function. The inputs are the x and y variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> vals[,<span class="dv">1</span>] </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> vals[,<span class="dv">2</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">expl_boundary</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">shells=</span><span class="dv">10</span>,<span class="at">simulations=</span><span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Reduce the number of simulations and see the effect</li>
</ol>
</div>
</div>
</section>
</section>
<section id="boundary-model-fitting-methods" class="level2">
<h2 class="anchored" data-anchor-id="boundary-model-fitting-methods">5. Boundary Model Fitting Methods</h2>
<section id="bolides-algorithm" class="level3">
<h3 class="anchored" data-anchor-id="bolides-algorithm">5.1 Bolides algorithm</h3>
<p>This method fit the boundary line following the boundary line determination technique proposed by Schnug <em>et al.</em> (1995). To fit the boundary line using the BOLIDES algorithm , the <code>bolides()</code> function can be used. To check the required arguments for the function, the help page can be launched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>?bolides</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The arguments <em><code>x</code></em> and <em><code>y</code></em> are the independent and dependent variable respectively and <code>start</code> is a vector of starting values . The <code>model</code> argument is used to specify the model of the boundary line e.g.&nbsp;“blm” for the linear model. The <code>xmax</code> is an argument that describes the maximum value of the independent variable beyond which the relation of <em><code>x</code></em> and <em><code>y</code></em> is no longer theoretically feasible. Other arguments relate to the plot parameters as in the <code>plot()</code> function.</p>
<p>All boundary fitting methods require initial starting values for the parameters of a proposed model. The initial starting values are optimized to find the parameters of the proposed model as in the <code>optim()</code> function in base <code>R</code>.</p>
<p>To get the start starting values, the <code>bolides()</code> function is run with the argument <code>model="explore"</code>. This allows us to view the selected boundary points using the boundary line determination technique.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>y,<span class="at">model =</span> <span class="st">"explore"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the plot, it can be seen that a “trapezium” model will be more appropriate for this data set. The function <code>startValues()</code> can be used to determine initial start values. For more information on <code>startValues()</code> function see <code>?startValues()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>?<span class="fu">startValues</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With a scatter plot of <em><code>y</code></em> against <em><code>x</code></em> active in the plot window in <code>R</code>, run the function <code>startValues("trapezium")</code>, then use the mouse to click on the plot at five boundary points that follow the trapezium model in order of increasing <em><code>x</code></em> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>) <span class="co"># then select the five points at the edge of the dataset that make up the trapezium model in order of increasing x values.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The proposed start values will be produced. Note that this can be done for other models as well. Once all the arguments are set, the function can be run</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">14</span>,<span class="dv">104</span>,<span class="sc">-</span><span class="dv">22</span>) <span class="co"># start values is a vector of five consists of intercept, slope, plateau yield, intercept2 and slope2. </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>model3 <span class="ot">&lt;-</span> <span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>x, <span class="at">start =</span> start,<span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>model2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results show that the optimized parameters and plot of the fitted model. There is no uncertainty in the parameters because this is a heuristic method.</p>
<p>These parameters can then be used to determine boundary line response for any given value of <em><code>x</code></em>. Say you want to predict the maximum possible yield response at soil P values of 4.5, 7.4, 12.2, 20.1 and 54.5 mg/kg. Remember that our model was fitted on values of log soil P and therefore, these values must first be log transformed before the prediction is made. We can use the function <code>predictBL()</code> for this purpose. For more information on this function, see <code>?predictBL()</code> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">4.5</span>, <span class="fl">7.4</span>, <span class="fl">12.2</span>, <span class="fl">20.1</span>, <span class="fl">54.5</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>P_log <span class="ot">&lt;-</span> <span class="fu">log</span>(P)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>Max_Response <span class="ot">&lt;-</span> <span class="fu">predictBL</span>(model3, P_log) <span class="co"># the argument inputs are the boundary line model and the independent values (in this case P_log)</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>Max_Response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 1</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<p>Give an exercise 3 here</p>
</div>
</div>
</section>
<section id="binning-method" class="level3">
<h3 class="anchored" data-anchor-id="binning-method">5.2 Binning method</h3>
<p>The binning methodology involves splitting the data into several sections in the x-axis and selecting a boundary point in each section based on a set criteria (mostly the 95<span class="math inline">\(^{\rm th}\)</span> and 99<span class="math inline">\(^{\rm th}\)</span> percentile) (Shatar and McBratney, 2004). To fit the boundary line using the binning method, the <code>blbin()</code> function can be used. To check the required arguments for the function, the help page can be launched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>?blbin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The arguments <em><code>x</code></em> and <em><code>y</code></em> are the independent and dependent variable respectively and <code>start</code> is a vector of starting values . The <code>model</code> argument is used to specify the model of the boundary line e.g.&nbsp;<code>model="blm"</code> for the linear model. The <code>bins</code> argument describes the size of the bins with a vector of length 3 containing the minimum and maximum independent variable values, and the size of bins to be used for the data respectively. We assume that the 99<span class="math inline">\(^{\rm th}\)</span> percentile (<code>tau=0.99</code>) is the boundary.</p>
<p>The initial start start values can be determined as previously shown in the previous section</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bins <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.61</span>,<span class="fl">4.74</span>,<span class="fl">0.313</span>) </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">blbin</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, bins,<span class="at">model =</span> <span class="st">"explore"</span>, <span class="at">tau=</span><span class="fl">0.99</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From the plot, it can be seen that a “trapezium” model will be more appropriate for this data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The values for <code>start</code> can now be obtained and the function can now be run.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">4.75</span>, <span class="fl">3.23</span>, <span class="fl">13.3</span>, <span class="fl">24.87</span>,<span class="sc">-</span><span class="fl">2.95</span> )</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>model1 <span class="ot">&lt;-</span> <span class="fu">blbin</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, bins,<span class="at">start =</span> start,<span class="at">model =</span> <span class="st">"trapezium"</span>, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">tau=</span><span class="fl">0.99</span>, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"t ha"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>model1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results show that the optimized parameters and plot. There is no uncertainty in the parameters because this is a heuristic method. These parameters can then be used to determine boundary line response for any given value of <em><code>x</code></em> using the <code>predictBL()</code> function.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 2</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Experiment with different sizes of <code>bins</code> and <code>tau</code> values</li>
<li>What is the effect on the output?</li>
<li>What would be the effect on analysis?</li>
</ol>
</div>
</div>
</section>
<section id="quantile-regression-method" class="level3">
<h3 class="anchored" data-anchor-id="quantile-regression-method">5.3 Quantile regression method</h3>
<p>This method fits the boundary line using the principle of quantile regression (Cade and Noon, 2003). To fit the boundary line using the quantile regression method, the <code>blqr()</code> function can be used. To check the required arguments for the function, the help page can be launched.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>?blqr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The arguments <em><code>x</code></em> and <em><code>y</code></em> are the independent and dependent variable respectively and <code>start</code> is a vector of starting values . The <code>model</code> argument is used to specify the model of the boundary line e.g.&nbsp;“blm” for the linear model. The argument <code>tau</code> describes the quantile value described as boundary. We assume that the 99<span class="math inline">\(^{\rm th}\)</span> quantile (<code>tau=0.99</code>) value is the boundary. This is an arbitrary assumption, and for this reason we treat the method as heuristic.</p>
<p>The initial start start values can be determined as previously shown in the previous section. however, the <code>blqr()</code> function does not have the explore option and hence the <code>startValues()</code> function is used just on the plot of <em><code>x</code></em> and <em><code>y</code></em> directly according to the suggested model from the structure at the upper edge of the data. The trapezium model will be used for this data.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x,y)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>start</code>values can now be used in the <code>blqr()</code> function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">3</span>,<span class="fl">13.5</span>,<span class="dv">31</span>,<span class="sc">-</span><span class="fl">4.5</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>model2 <span class="ot">&lt;-</span> <span class="fu">blqr</span>(<span class="at">x=</span>x,<span class="at">y=</span>y, <span class="at">start =</span> start, <span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ mg L"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">pch=</span><span class="dv">16</span>,<span class="at">tau=</span><span class="fl">0.99</span>, <span class="at">col=</span><span class="st">"grey"</span>) <span class="co"># may take a few seconds to ran</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>model2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results show that the optimized parameters and plot. The quantile regression method will produce measures of uncertainty for parameters, but BLA does not report these because they are conditional on the arbitrary choice of <code>tau</code>. These parameters can then be used to determine boundary line response for any given value of <em><code>x</code></em> using the <code>predictBL()</code> function.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 3</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<p>Give an exercise 2 here</p>
</div>
</div>
</section>
<section id="censored-bivariate-normal-model" class="level3">
<h3 class="anchored" data-anchor-id="censored-bivariate-normal-model">5.4 Censored bivariate normal model</h3>
<p>Before fitting the boundary line model, the data is plotted to get a feel of the distribution of points at the upper edges. This allows the selection of an appropriate boundary model. This should be supported by biological/agronomic plausibility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x,y,<span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>, <span class="at">xlab=</span><span class="st">"soil P"</span>, <span class="at">ylab =</span> <span class="st">"Yield (t/ha)"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A trapezium boundary model is appropriate for this data. The censored bivariate normal procedure (cbvn) will be used to fit the boundary model. To fit the cbvn, some arguments need to be estimated. These include the initial starting values of the trapezium model and value for the standard deviation of measurement error.</p>
<section id="determination-of-initial-starting-values" class="level4">
<h4 class="anchored" data-anchor-id="determination-of-initial-starting-values">5.4.1 Determination of initial starting values</h4>
<p>Here we come up with the initial starting values for the optimization process. Since the selected model is the trapezium, the starting values will be a vector of length 10 comprising the y-intercept, slope, plateau value, second y-intercept, second slope and data distribution properties i.e means of <code>x</code> and <code>y</code>, standard deviation of <code>x</code> and <code>y</code>, and their correlation.</p>
<p>To determine start values for the selected trapezium model, the <code>startValues()</code> function is used. We determine several start values to avoid sticking to a local optimum solution. Note that for the <code>startValues()</code> function to work effectively, the appearance zoom in the global options of R and your computer display zoom should be equal i.e.both should be at 100%.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">startValues</span>(<span class="st">"trapezium"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>click on the plot 4 points that make up the trapezium structure at the upper edge of the data cloud in a clockwise movement. We run this step multiple times and the values are added to the list of starting values below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>start<span class="ot">&lt;-</span><span class="fu">list</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">4.3</span>,<span class="fl">3.4</span>,<span class="fl">13.8</span>,<span class="fl">32.8</span>,<span class="sc">-</span><span class="fl">4.9</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">2.5</span>,<span class="fl">4.1</span>,<span class="fl">13.42</span>,<span class="dv">32</span>,<span class="sc">-</span><span class="fl">4.8</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">3.5</span>,<span class="fl">3.7</span>,<span class="fl">13.35</span>,<span class="fl">47.7</span>,<span class="sc">-</span><span class="fl">8.4</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">2.83</span>,<span class="fl">4.11</span>,<span class="fl">13.7</span>,<span class="fl">32.</span>,<span class="sc">-</span><span class="fl">4.6</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y)),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fl">4.1</span>,<span class="fl">3.4</span>,<span class="fl">13.6</span>,<span class="dv">29</span>,<span class="sc">-</span><span class="fl">4.1</span>,<span class="fu">mean</span>(x),<span class="fu">mean</span>(y),<span class="fu">sd</span>(x),<span class="fu">sd</span>(y),<span class="fu">cor</span>(x,y))</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="determination-of-standard-deviation-of-measurement-error" class="level4">
<h4 class="anchored" data-anchor-id="determination-of-standard-deviation-of-measurement-error">5.4.2 Determination of standard deviation of measurement error</h4>
<p>The standard deviation of measurement error (<code>sigh</code>) is a fixed parameter in the boundary line determination using cbvn. As we do not have a direct measure of <code>sigh</code>, it is determined by log-likelihood profiling. In this process, the negative log-likelihoods of several suggested values of sigh are determined given the data distribution and the suggested model. The sigh value with the smallest negative log-likelihood is selected. This is done using the <code>ble_profile()</code> function at the multiple start values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sigh<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.3</span>,<span class="fl">0.4</span>,<span class="fl">0.5</span>,<span class="fl">0.6</span>,<span class="fl">0.7</span>,<span class="fl">0.8</span>,<span class="fl">0.9</span>,<span class="dv">1</span>) <span class="co"># we suggest sigh values ranging from 0.3 to 1 t/ha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note</strong>: This function will take a few minutes to run as it is evaluating each sigh value for each set of start values. We use the lapply function to loop over each sigh and start value set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>profile <span class="ot">&lt;-</span> <span class="fu">lapply</span>(start, <span class="cf">function</span>(start) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(sigh, <span class="cf">function</span>(sigh) {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ble_profile</span>(<span class="at">data =</span> vals, <span class="at">start =</span> start, <span class="at">sigh =</span> sigh, <span class="at">model =</span> <span class="st">"trapezium"</span>, <span class="at">plot =</span> F)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract log-likelihood and sigh (Merror) values from profile list</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>log_likelihood <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(profile, <span class="cf">function</span>(sublist) {</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(sublist, <span class="cf">function</span>(x) x[[<span class="st">"log-likelihood"</span>]])</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>Merror<span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(profile, <span class="cf">function</span>(sublist) {</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(sublist, <span class="cf">function</span>(x) x[[<span class="st">"Merror"</span>]])</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>}))</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># The sigh with the smallest negative log-likelihood </span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>Merror[<span class="fu">which</span>(log_likelihood<span class="sc">==</span><span class="fu">max</span>(log_likelihood, <span class="at">na.rm =</span> T))]<span class="co"># profile maximized  at 0.4 t/ha</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plotting the log-likelihood profile for visualization</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>me_profile<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">x=</span>Merror,<span class="at">y=</span>log_likelihood)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>me_profile<span class="ot">&lt;-</span>me_profile[<span class="fu">order</span>(Merror),] <span class="co"># ordering data from smallest to largest Merror</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>vec<span class="ot">&lt;-</span><span class="fu">vector</span>()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">unique</span>(me_profile<span class="sc">$</span>x)){ </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  maxy<span class="ot">&lt;-</span><span class="fu">max</span>(me_profile[<span class="fu">which</span>(me_profile<span class="sc">$</span>x<span class="sc">==</span>i),]<span class="sc">$</span>y, <span class="at">na.rm =</span> T)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  vec<span class="ot">&lt;-</span><span class="fu">c</span>(vec,maxy)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ploting the largest value at each Merror</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">5</span>,<span class="dv">4</span>,<span class="dv">4</span>))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">unique</span>(me_profile<span class="sc">$</span>x),vec,<span class="at">pch=</span><span class="dv">16</span>, </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">bold</span>(sigma[e]<span class="sc">*</span><span class="st">"/t ha"</span><span class="sc">^-</span><span class="dv">1</span>)),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="fu">expression</span>(<span class="fu">bold</span>(log<span class="sc">-</span>Likelihood)),</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">cex.lab=</span><span class="fl">1.8</span>, <span class="at">cex.axis=</span><span class="fl">1.8</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">unique</span>(me_profile<span class="sc">$</span>x),vec, <span class="at">lty=</span><span class="dv">5</span>, <span class="at">lwd=</span><span class="fl">1.5</span>) </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span>Merror[<span class="fu">which</span>(log_likelihood<span class="sc">==</span><span class="fu">max</span>(log_likelihood, <span class="at">na.rm =</span> T))],</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">lty=</span><span class="dv">5</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="fl">1.3</span>) <span class="co"># sigh with largest log-likelihood</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-the-boundary-line-using-cbvn-model" class="level4">
<h4 class="anchored" data-anchor-id="fitting-the-boundary-line-using-cbvn-model">5.4.3 Fitting the boundary line using cbvn model</h4>
<p>All the arguments for the censored bivariate normal model function are set. To fit the boundary line, the function <code>cbvn()</code> is used. We do this using multiple start values to avoid sticking at a local optimum solution. The solution with the smallest negative log-likelihood value is selected. This is equivalent to selecting the model with the smallest Aikaike Information Criterion (AIC) value, which is an output of the <code>cbvn()</code> function. The <code>lapply()</code> function is used here to allows us to loop the <code>cbvn()</code> over the different start values. The <code>tryCatch()</code> allows the loop function to continue to the next input when the function fails to converge at a given input combination.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">lapply</span>(start, <span class="cf">function</span>(start) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cbvn</span>(<span class="at">data=</span>vals, <span class="at">start =</span> start, <span class="at">sigh=</span><span class="fl">0.4</span>, <span class="at">model =</span> <span class="st">"trapezium"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">optim.method =</span> <span class="st">"Nelder-Mead"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ mg L"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Yield/ t ha"</span><span class="sc">^-</span><span class="dv">1</span>), <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NA</span>) </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Selects the solution with the smallest value of <strong>AIC</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>model_4 <span class="ot">&lt;-</span> models[[<span class="fu">which.min</span>(<span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="at">X=</span>models,<span class="at">FUN =</span> <span class="cf">function</span>(a){</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  b<span class="ot">&lt;-</span><span class="fu">tryCatch</span>(a<span class="sc">$</span>AIC[<span class="dv">2</span>,<span class="dv">1</span>],<span class="at">error=</span><span class="cf">function</span>(e) <span class="cn">NA</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(b)})))]]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>Model_4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 5</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Determine the boundary line for soil pH from the Soil dataset (within the BLA) and assign it Model_5. Use the <code>sigh = 0.6</code>. There is no need to test for presence of boundary as it has already been established earlier for Soil P</li>
</ol>
</div>
</div>
</section>
</section>
</section>
<section id="predicting-boundary-yield-for-each-data-point-in-our-dataset" class="level2">
<h2 class="anchored" data-anchor-id="predicting-boundary-yield-for-each-data-point-in-our-dataset">6. Predicting boundary yield for each data point in our dataset</h2>
<p>The largest expected yield for each value of soil P in our data set is estimated from the boundary line model parameters. This is done using the function <code>predictBL()</code>. The inputs are the model object and a vector of soil P values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>P_data <span class="ot">&lt;-</span><span class="fu">log</span>(soil<span class="sc">$</span>P) <span class="co"># extracting soil P from the data set</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                     <span class="co"># replace missing values with mean soil P value</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>P<span class="ot">&lt;-</span><span class="fu">predictBL</span>(model_1,P_data) <span class="co"># boundary yield for soil P</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 6</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>Use the results from your model5 for soil pH to predict the largest yields for each value of soil pH. Replace the missing pH value with the mean.</li>
</ol>
</div>
</div>
</section>
<section id="posthoc-analysis" class="level2">
<h2 class="anchored" data-anchor-id="posthoc-analysis">8. Posthoc Analysis</h2>
</section>
<section id="additional-material-using-your-own-defined-model" class="level2">
<h2 class="anchored" data-anchor-id="additional-material-using-your-own-defined-model">9. Additional Material: Using your own defined model</h2>
<p>The illustrated methods for fitting the boundary line have some in-built models. These include the linear, linear plateau, mitscherlich, schmidt, logistic, logistic model proposed by Nelder (1961), the inverse logistic, double logistic, quadratic and the trapezium models. However, there are some cases where one wants to fit another model which is not part of the built in models. The following steps will illustrate how to fit a custom model. Though this will be illustrated using the <code>bolides()</code> function, it also applies for the <code>blbin()</code>, <code>blqr()</code> and <code>cbvn()</code> functions.</p>
<p>Assuming that the initial data exploratory step have been done, the first step is to check the structure of the boundary points using the argument <code>model="explore"</code> in the <code>bolides()</code> function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bolides</span>(<span class="at">x=</span>x,<span class="at">y=</span>x,<span class="at">model=</span><span class="st">"explore"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">col=</span><span class="st">"grey"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets say you want to fit a model</p>
<p><span class="math display">\[
y=\beta_0 - \beta_1(x-\beta_2)^2
\]</span></p>
<p>The model is written in form of an <code>R</code> function and the parameters should always be written in alphabetical order as <em><strong>a</strong>, <strong>b</strong></em> and <strong><em>c</em></strong> for a three parameter function, <em><strong>a</strong>, <strong>b</strong>,<strong>c</strong></em> and <strong><em>d</em></strong> for four parameter function and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>custom_function<span class="ot">&lt;-</span><span class="cf">function</span>(x,a,b,c){</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">&lt;-</span> a <span class="sc">-</span> b<span class="sc">*</span>(x<span class="sc">-</span>c)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The next step is to suggest the initial start <code>start</code> values. These should be sensible values else the function will not converge. These should be arranges in alphabetical order as <code>start=c(a,b,c)</code>. Replace a, b and c with numeric values of your choice.</p>
<p>The arguments of <code>bolides()</code> function can now be added. In this case, the argument model while be set to “other”. The arguments equation is now set to your custom function (<code>equation=custom_function</code>)</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>start<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">13.5</span>,<span class="dv">3</span>,<span class="fl">3.3</span>)  </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>model4<span class="ot">&lt;-</span><span class="fu">bolides</span>(x,y, <span class="at">start =</span> start,<span class="at">model =</span> <span class="st">"other"</span>,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">equation=</span>custom_function,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/mg L"</span><span class="sc">^-</span><span class="dv">1</span>), </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Phosphorus/ln(mg L"</span><span class="sc">^-</span><span class="dv">1</span><span class="sc">*</span><span class="st">")"</span>), </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">pch=</span><span class="dv">16</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="fl">3.8</span>,<span class="fl">14.5</span>), <span class="at">col=</span><span class="st">"grey"</span>,<span class="at">bp_col=</span><span class="st">"grey"</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>model4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The parameters of the models are shown in the results. A prediction of the boundary response values for each value of <em><code>x</code></em> can the be done as previously shown using the <code>predictBL()</code> function.</p>
<div class="card">
<button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#my-collapse">
<p>Exercise 7</p>
</button>
<div id="my-collapse" class="collapse mt-3">
<ol type="1">
<li>From the variables in data, choose one and fit the boundary line model using a custom model of your choice.</li>
</ol>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>